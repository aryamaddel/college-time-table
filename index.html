<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mobile Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <main class="container mx-auto px-4 py-6">
      <time id="clock" class="block text-center text-xl mb-6"></time>
      <section
        id="current-lecture"
        class="bg-white rounded-lg shadow-md p-4 mb-6"
      ></section>
      <nav id="day-selector" class="flex justify-between mb-6"></nav>
      <section
        id="full-timetable"
        class="bg-white rounded-lg shadow-md p-4"
      ></section>
    </main>

    <footer class="text-center py-4 text-gray-600">
      <p>
        Made by
        <a
          href="https://github.com/aryamaddel"
          class="text-green-600 hover:underline"
          >Arya Maddel</a
        >
        ðŸ’š
      </p>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const DAYS_OF_WEEK = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
        ];
        const SHORT_DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri"];

        // Define button class strings
        const selectedClasses = "bg-blue-500 text-white";
        const unselectedClasses = "bg-gray-200 text-gray-700";

        let timetable = {};
        let currentDay = "";
        let currentLecture = null;

        const elements = {
          currentLecture: document.getElementById("current-lecture"),
          timetable: document.getElementById("full-timetable"),
          clock: document.getElementById("clock"),
          daySelector: document.getElementById("day-selector"),
        };

        function getCurrentDay() {
          const day = new Date().getDay() - 1;
          return day >= 0 && day < DAYS_OF_WEEK.length
            ? DAYS_OF_WEEK[day]
            : DAYS_OF_WEEK[0];
        }

        function convertTo12Hour(time) {
          const [hour, minute] = time.split(":").map(Number);
          return `${hour % 12 || 12}:${minute.toString().padStart(2, "0")} ${
            hour >= 12 ? "PM" : "AM"
          }`;
        }

        async function loadTimetable() {
          try {
            const response = await fetch("timetable.json");
            if (!response.ok) throw new Error("Failed to load timetable");
            timetable = await response.json();
            setupDaySelector();
            updateCurrentInfo();
            setInterval(updateCurrentInfo, 1000);
          } catch (error) {
            console.error("Error loading timetable:", error);
            elements.currentLecture.innerHTML =
              "<p class='text-red-500'>Failed to load timetable. Please try again later.</p>";
          }
        }

        function setupDaySelector() {
          elements.daySelector.innerHTML = "";
          SHORT_DAYS.forEach((day, index) => {
            const button = document.createElement("button");
            button.textContent = day;
            button.className = `py-2 px-4 rounded-lg focus:outline-none ${unselectedClasses}`;
            button.addEventListener("click", () =>
              selectDay(DAYS_OF_WEEK[index])
            );
            elements.daySelector.appendChild(button);
          });
          selectDay(getCurrentDay());
        }

        function selectDay(day) {
          currentDay = day;
          document
            .querySelectorAll("#day-selector button")
            .forEach((btn, index) => {
              const classes =
                DAYS_OF_WEEK[index] === day
                  ? selectedClasses
                  : unselectedClasses;
              btn.className = `py-2 px-4 rounded-lg focus:outline-none ${classes}`;
            });
          displayFullTimetable();
        }

        function getCurrentLecture() {
          const now = new Date();
          const day = getCurrentDay();
          const currentMinutes = now.getHours() * 60 + now.getMinutes();

          return (
            timetable[day]?.find((lecture) => {
              const [startHour, startMinute] = lecture.start_time
                .split(":")
                .map(Number);
              const [endHour, endMinute] = lecture.end_time
                .split(":")
                .map(Number);
              const startMinutes = startHour * 60 + startMinute;
              const endMinutes = endHour * 60 + endMinute;
              return (
                currentMinutes >= startMinutes && currentMinutes <= endMinutes
              );
            }) || null
          );
        }

        function updateCurrentInfo() {
          elements.clock.textContent = new Date().toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });

          currentLecture = getCurrentLecture();

          if (currentLecture) {
            const { lecture, start_time, end_time, room } = currentLecture;
            elements.currentLecture.innerHTML = `
              <h2 class="text-xl font-semibold mb-2">Current Lecture</h2>
              <p class="text-lg font-bold text-blue-600">${lecture}</p>
              <p class="text-md">${convertTo12Hour(
                start_time
              )} - ${convertTo12Hour(end_time)}</p>
              <p class="text-md">Room: ${room}</p>
              <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full"></div>
              </div>
            `;
            updateProgressBar();
          } else {
            elements.currentLecture.innerHTML = `
              <h2 class="text-xl font-semibold mb-2">No Current Lecture</h2>
              <p class="text-gray-500">Enjoy your break!</p>
            `;
          }
        }

        function updateProgressBar() {
          if (!currentLecture) return;

          const now = new Date();
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          const [startHour, startMinute] = currentLecture.start_time
            .split(":")
            .map(Number);
          const [endHour, endMinute] = currentLecture.end_time
            .split(":")
            .map(Number);
          const startMinutes = startHour * 60 + startMinute;
          const endMinutes = endHour * 60 + endMinute;

          const totalDuration = endMinutes - startMinutes;
          const elapsedTime = currentMinutes - startMinutes;
          const progressPercentage = Math.min(
            Math.max((elapsedTime / totalDuration) * 100, 0),
            100
          );

          const progressBar = document.getElementById("progress-bar");
          if (progressBar) {
            progressBar.style.width = `${progressPercentage}%`;
          }
        }

        function displayFullTimetable() {
          const daySchedule = timetable[currentDay];
          let content = `<h3 class="text-lg font-semibold mb-4">${currentDay}'s Schedule</h3>`;
          if (daySchedule?.length) {
            const lecturesHtml = daySchedule
              .map(
                ({ lecture, start_time, end_time, room }) => `
                  <div class="border-l-4 border-blue-500 pl-4 py-2">
                    <p class="font-bold text-gray-800">${lecture}</p>
                    <p class="text-sm text-gray-600">${convertTo12Hour(
                      start_time
                    )} - ${convertTo12Hour(end_time)}</p>
                    <p class="text-sm text-gray-600">Room: ${room}</p>
                  </div>
                `
              )
              .join("");
            content += `<div class="space-y-4">${lecturesHtml}</div>`;
          } else {
            content += `<p class="text-gray-500">No classes scheduled for this day.</p>`;
          }
          elements.timetable.innerHTML = content;
        }

        loadTimetable();
      });
    </script>
  </body>
</html>
