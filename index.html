<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mobile Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Service Worker Registration -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/sw.js")
          .then((reg) => console.log("Service Worker registered"))
          .catch((err) => console.log("SW registration failed:", err));
      }
    </script>

    <main class="container mx-auto px-4 py-6">
      <time id="clock" class="block text-center text-xl mb-6"></time>
      <section
        id="current-lecture"
        class="bg-white rounded-lg shadow-md p-4 mb-6"
      ></section>
      <nav id="day-selector" class="flex justify-between mb-6"></nav>
      <section
        id="full-timetable"
        class="bg-white rounded-lg shadow-md p-4"
      ></section>
    </main>

    <footer class="text-center py-4 text-gray-600">
      <p>
        Made by
        <a
          href="https://github.com/aryamaddel"
          class="text-green-600 hover:underline"
          >Arya Maddel</a
        >
        ðŸ’š
      </p>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Constants
        const DAYS_OF_WEEK = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
        ];
        const SHORT_DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri"];
        const CACHE_NAME = "timetable-v1";

        // State variables
        let timetable = {};
        let currentDay = "";
        let currentLecture = null;

        // DOM elements
        const elements = {
          currentLecture: document.getElementById("current-lecture"),
          timetable: document.getElementById("full-timetable"),
          clock: document.getElementById("clock"),
          daySelector: document.getElementById("day-selector"),
        };

        // Helper functions
        function getCurrentDay() {
          const day = new Date().getDay() - 1;
          return day >= 0 && day < DAYS_OF_WEEK.length
            ? DAYS_OF_WEEK[day]
            : DAYS_OF_WEEK[0];
        }

        function convertTo12Hour(time) {
          const [hour, minute] = time.split(":").map(Number);
          return `${hour % 12 || 12}:${minute.toString().padStart(2, "0")} ${
            hour >= 12 ? "PM" : "AM"
          }`;
        }

        // Offline-enabled timetable loader
        async function loadTimetable() {
          try {
            // Try network first
            const networkResponse = await fetch("timetable.json");
            if (networkResponse.ok) {
              timetable = await networkResponse.json();
              setupDaySelector();
              updateCurrentInfo();
              setInterval(updateCurrentInfo, 1000);
              return;
            }
          } catch (networkError) {
            console.log("Network failed, trying cache...");
          }

          // Cache fallback
          try {
            const cache = await caches.open(CACHE_NAME);
            const cachedResponse = await cache.match("timetable.json");

            if (cachedResponse) {
              timetable = await cachedResponse.json();
              setupDaySelector();
              updateCurrentInfo();
              setInterval(updateCurrentInfo, 1000);
            } else {
              showError("No cached timetable available");
            }
          } catch (cacheError) {
            showError("Failed to load timetable");
          }
        }

        function showError(message) {
          elements.currentLecture.innerHTML = `<p class='text-red-500'>${message}</p>`;
        }

        function setupDaySelector() {
          elements.daySelector.innerHTML = "";
          SHORT_DAYS.forEach((day, index) => {
            const button = document.createElement("button");
            button.textContent = day;
            button.className = "py-2 px-4 rounded-lg focus:outline-none";
            button.addEventListener("click", () =>
              selectDay(DAYS_OF_WEEK[index])
            );
            elements.daySelector.appendChild(button);
          });
          selectDay(getCurrentDay());
        }

        function selectDay(day) {
          currentDay = day;
          document
            .querySelectorAll("#day-selector button")
            .forEach((btn, index) => {
              const isSelected = DAYS_OF_WEEK[index] === day;
              btn.classList.toggle("bg-blue-500", isSelected);
              btn.classList.toggle("text-white", isSelected);
              btn.classList.toggle("bg-gray-200", !isSelected);
              btn.classList.toggle("text-gray-700", !isSelected);
            });
          displayFullTimetable();
        }

        function getCurrentLecture() {
          const now = new Date();
          const day = getCurrentDay();
          const currentMinutes = now.getHours() * 60 + now.getMinutes();

          return (
            timetable[day]?.find((lecture) => {
              const [startHour, startMinute] = lecture.start_time
                .split(":")
                .map(Number);
              const [endHour, endMinute] = lecture.end_time
                .split(":")
                .map(Number);
              const startMinutes = startHour * 60 + startMinute;
              const endMinutes = endHour * 60 + endMinute;
              return (
                currentMinutes >= startMinutes && currentMinutes <= endMinutes
              );
            }) || null
          );
        }

        function updateCurrentInfo() {
          elements.clock.textContent = new Date().toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });

          currentLecture = getCurrentLecture();

          if (currentLecture) {
            const { lecture, start_time, end_time, room } = currentLecture;
            elements.currentLecture.innerHTML = `
              <h2 class="text-xl font-semibold mb-2">Current Lecture</h2>
              <p class="text-lg font-bold text-blue-600">${lecture}</p>
              <p class="text-md">${convertTo12Hour(
                start_time
              )} - ${convertTo12Hour(end_time)}</p>
              <p class="text-md">Room: ${room}</p>
              <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full"></div>
              </div>
            `;
            updateProgressBar();
          } else {
            elements.currentLecture.innerHTML = `
              <h2 class="text-xl font-semibold mb-2">No Current Lecture</h2>
              <p class="text-gray-500">Enjoy your break!</p>
            `;
          }
        }

        function updateProgressBar() {
          if (!currentLecture) return;

          const now = new Date();
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          const [startHour, startMinute] = currentLecture.start_time
            .split(":")
            .map(Number);
          const [endHour, endMinute] = currentLecture.end_time
            .split(":")
            .map(Number);
          const startMinutes = startHour * 60 + startMinute;
          const endMinutes = endHour * 60 + endMinute;

          const totalDuration = endMinutes - startMinutes;
          const elapsedTime = currentMinutes - startMinutes;
          const progressPercentage = Math.min(
            Math.max((elapsedTime / totalDuration) * 100, 0),
            100
          );

          const progressBar = document.getElementById("progress-bar");
          if (progressBar) {
            progressBar.style.width = `${progressPercentage}%`;
          }
        }

        function displayFullTimetable() {
          const daySchedule = timetable[currentDay];

          let content = `<h3 class="text-lg font-semibold mb-4">${currentDay}'s Schedule</h3>`;

          if (daySchedule?.length) {
            content += '<div class="space-y-4">';
            daySchedule.forEach(({ lecture, start_time, end_time, room }) => {
              content += `
                <div class="border-l-4 border-blue-500 pl-4 py-2">
                  <p class="font-bold text-gray-800">${lecture}</p>
                  <p class="text-sm text-gray-600">${convertTo12Hour(
                    start_time
                  )} - ${convertTo12Hour(end_time)}</p>
                  <p class="text-sm text-gray-600">Room: ${room}</p>
                </div>
              `;
            });
            content += "</div>";
          } else {
            content += `<p class="text-gray-500">No classes scheduled for this day.</p>`;
          }

          elements.timetable.innerHTML = content;
        }

        // Initialize
        loadTimetable();
      });
    </script>
  </body>
</html>
