<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mobile Timetable</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <main class="container mx-auto px-4 py-6">
      <time id="clock" class="block text-center text-xl mb-6"></time>

      <section
        id="current-lecture"
        class="bg-white rounded-lg shadow-md p-4 mb-6"
      ></section>

      <nav id="day-selector" class="flex justify-between mb-6"></nav>

      <section
        id="full-timetable"
        class="bg-white rounded-lg shadow-md p-4"
      ></section>
    </main>

    <footer class="text-center py-4 text-gray-600">
      <p>
        Made by
        <a
          href="https://github.com/aryamaddel"
          class="text-green-600 hover:underline"
          >Arya Maddel</a
        >
        ðŸ’š
      </p>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const DAYS_OF_WEEK = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
        ];
        const SHORT_DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri"];
        const UPDATE_INTERVAL = 1000;

        let timetable = {};
        let currentDay = "";
        let currentLecture = null;

        const currentLectureElement =
          document.getElementById("current-lecture");
        const fullTimetableElement = document.getElementById("full-timetable");
        const clockElement = document.getElementById("clock");
        const daySelector = document.getElementById("day-selector");

        const getCurrentDay = () => {
          const day = new Date().getDay() - 1;
          return day >= 0 && day < DAYS_OF_WEEK.length
            ? DAYS_OF_WEEK[day]
            : DAYS_OF_WEEK[0];
        };

        const convertTo12Hour = (time) => {
          const [hour, minute] = time.split(":").map(Number);
          const period = hour >= 12 ? "PM" : "AM";
          const adjustedHour = hour % 12 || 12;
          return `${adjustedHour}:${minute
            .toString()
            .padStart(2, "0")} ${period}`;
        };

        async function loadTimetable() {
          try {
            const response = await fetch("timetable.json");
            if (!response.ok) {
              throw new Error("Failed to load timetable");
            }

            timetable = await response.json();

            setupDaySelector();
            updateCurrentInfo();
            setInterval(updateCurrentInfo, UPDATE_INTERVAL);
          } catch (error) {
            console.error("Error loading timetable:", error);
            currentLectureElement.innerHTML =
              "<p class='text-red-500'>Failed to load timetable. Please try again later.</p>";
          }
        }

        function setupDaySelector() {
          daySelector.innerHTML = ""; // Clear any existing buttons
          SHORT_DAYS.forEach((day, index) => {
            const button = document.createElement("button");
            button.textContent = day;
            button.className = "py-2 px-4 rounded-lg focus:outline-none";
            button.addEventListener("click", () =>
              selectDay(DAYS_OF_WEEK[index])
            );
            daySelector.appendChild(button);
          });
          selectDay(getCurrentDay());
        }

        function selectDay(day) {
          currentDay = day;
          document
            .querySelectorAll("#day-selector button")
            .forEach((btn, index) => {
              if (DAYS_OF_WEEK[index] === day) {
                btn.classList.add("bg-blue-500", "text-white");
                btn.classList.remove("bg-gray-200", "text-gray-700");
              } else {
                btn.classList.add("bg-gray-200", "text-gray-700");
                btn.classList.remove("bg-blue-500", "text-white");
              }
            });
          displayFullTimetable();
        }

        function getCurrentLecture() {
          const now = new Date();
          const day = getCurrentDay();
          const currentTime = now.getHours() * 60 + now.getMinutes();

          return (
            timetable[day]?.find((lecture) => {
              const [startHour, startMinute] = lecture.start_time
                .split(":")
                .map(Number);
              const [endHour, endMinute] = lecture.end_time
                .split(":")
                .map(Number);
              const startTime = startHour * 60 + startMinute;
              const endTime = endHour * 60 + endMinute;
              return currentTime >= startTime && currentTime <= endTime;
            }) || null
          );
        }

        function updateCurrentInfo() {
          updateClock();
          displayCurrentLecture();
        }

        function displayCurrentLecture() {
          currentLecture = getCurrentLecture();

          if (currentLecture) {
            const { lecture, start_time, end_time, room } = currentLecture;
            currentLectureElement.innerHTML = `
              <h2 class="text-xl font-semibold mb-2">Current Lecture</h2>
              <p class="text-lg font-bold text-blue-600">${lecture}</p>
              <p class="text-md">${convertTo12Hour(
                start_time
              )} - ${convertTo12Hour(end_time)}</p>
              <p class="text-md">Room: ${room}</p>
              <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full"></div>
              </div>
            `;
            updateProgressBar();
          } else {
            currentLectureElement.innerHTML = `
              <h2 class="text-xl font-semibold mb-2">No Current Lecture</h2>
              <p class="text-gray-500">Enjoy your break!</p>
            `;
          }
        }

        function updateProgressBar() {
          if (currentLecture) {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const [startHour, startMinute] = currentLecture.start_time
              .split(":")
              .map(Number);
            const [endHour, endMinute] = currentLecture.end_time
              .split(":")
              .map(Number);
            const startTime = startHour * 60 + startMinute;
            const endTime = endHour * 60 + endMinute;
            const totalDuration = endTime - startTime;
            const elapsedTime = currentTime - startTime;
            const progressPercentage = Math.min(
              Math.max((elapsedTime / totalDuration) * 100, 0),
              100
            );

            const progressBar = document.getElementById("progress-bar");
            if (progressBar) {
              progressBar.style.width = `${progressPercentage}%`;
            }
          }
        }

        function displayFullTimetable() {
          const daySchedule = timetable[currentDay];

          let scheduleHTML = '<div class="space-y-4">';

          if (daySchedule && daySchedule.length > 0) {
            daySchedule.forEach(({ lecture, start_time, end_time, room }) => {
              scheduleHTML += `
                <div class="border-l-4 border-blue-500 pl-4 py-2">
                  <p class="font-bold text-gray-800">${lecture}</p>
                  <p class="text-sm text-gray-600">${convertTo12Hour(
                    start_time
                  )} - ${convertTo12Hour(end_time)}</p>
                  <p class="text-sm text-gray-600">Room: ${room}</p>
                </div>
              `;
            });
          } else {
            scheduleHTML += `<p class="text-gray-500">No classes scheduled for this day.</p>`;
          }

          scheduleHTML += "</div>";

          fullTimetableElement.innerHTML = `
            <h3 class="text-lg font-semibold mb-4">${currentDay}'s Schedule</h3>
            ${scheduleHTML}
          `;
        }

        function updateClock() {
          clockElement.textContent = new Date().toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        }

        loadTimetable();
      });
    </script>
  </body>
</html>
